/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.afrisoftech.hospital;

import java.io.UnsupportedEncodingException;
import java.sql.SQLException;
import java.util.logging.Level;
import java.util.logging.Logger;

/**
 *
 * @author root
 */
public class CallBackURSIntfr extends javax.swing.JInternalFrame {

    java.sql.Connection connectDB = null;

    public static String callBackURL = null;

    public static String validationURL = null;

    /**
     * Creates new form CallBackURSIntfr
     */
    public CallBackURSIntfr(java.sql.Connection connDB) {

        connectDB = connDB;

        initComponents();

    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        java.awt.GridBagConstraints gridBagConstraints;

        urlBodyPanel = new javax.swing.JPanel();
        paybillNoLbl = new javax.swing.JLabel();
        callbackURLLbl = new javax.swing.JLabel();
        validationURLLbl = new javax.swing.JLabel();
        paybillNoCmbx = new javax.swing.JComboBox<>();
        callbackURLTxt = new javax.swing.JTextField();
        validationURLTxt = new javax.swing.JTextField();
        urlActionPanel = new javax.swing.JPanel();
        spacerLbl = new javax.swing.JLabel();
        registerURLBtn = new javax.swing.JButton();
        closeFormBtn = new javax.swing.JButton();

        setClosable(true);
        setIconifiable(true);
        setMaximizable(true);
        setResizable(true);
        setTitle("Setting Call Back URL");
        setVisible(true);
        getContentPane().setLayout(new java.awt.GridBagLayout());

        urlBodyPanel.setBorder(javax.swing.BorderFactory.createTitledBorder("Set correct URLs"));
        urlBodyPanel.setLayout(new java.awt.GridBagLayout());

        paybillNoLbl.setText("Select Pay Bill Number");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        urlBodyPanel.add(paybillNoLbl, gridBagConstraints);

        callbackURLLbl.setText("Call Back URL");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        urlBodyPanel.add(callbackURLLbl, gridBagConstraints);

        validationURLLbl.setText("Validation URL");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        urlBodyPanel.add(validationURLLbl, gridBagConstraints);

        paybillNoCmbx.setModel(com.afrisoftech.lib.ComboBoxModel.ComboBoxModel(connectDB, "SELECT DISTINCT paybill_no FROM ac_cash_points ORDER BY 1")
        );
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        urlBodyPanel.add(paybillNoCmbx, gridBagConstraints);
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        urlBodyPanel.add(callbackURLTxt, gridBagConstraints);
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        urlBodyPanel.add(validationURLTxt, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 100.0;
        getContentPane().add(urlBodyPanel, gridBagConstraints);

        urlActionPanel.setLayout(new java.awt.GridBagLayout());
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 200.0;
        gridBagConstraints.weighty = 1.0;
        urlActionPanel.add(spacerLbl, gridBagConstraints);

        registerURLBtn.setText("Register URLs");
        registerURLBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                registerURLBtnActionPerformed(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        urlActionPanel.add(registerURLBtn, gridBagConstraints);

        closeFormBtn.setText("Close form");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        urlActionPanel.add(closeFormBtn, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        getContentPane().add(urlActionPanel, gridBagConstraints);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void registerURLBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_registerURLBtnActionPerformed

        String registerURL = paybillNoCmbx.getSelectedItem().toString();//javax.swing.JOptionPane.showInputDialog(this, "Register URL", "Call Back URL Registration", javax.swing.JOptionPane.QUESTION_MESSAGE);

        if (registerURL != null) {
            if (registerURL != null) {
                com.afrisoftech.hospital.HospitalMain.payBillNumber = registerURL;
                try {
                    java.sql.PreparedStatement pstmt = connectDB.prepareStatement("SELECT DISTINCT merchant_id, consumer_secrets FROM ac_cash_points WHERE paybill_no = ?");

                    pstmt.setString(1, registerURL);
                    java.sql.ResultSet rset = pstmt.executeQuery();
                    while (rset.next()) {
                        try {
                            com.afrisoftech.hospital.HospitalMain.passKey = new String(rset.getBytes(1), "UTF-8");
                            com.afrisoftech.hospital.HospitalMain.oAuthKey = new String(rset.getBytes(2), "UTF-8");
                        } catch (UnsupportedEncodingException ex) {
                            ex.printStackTrace();
                        }
                    }
                } catch (SQLException ex) {
                    javax.swing.JOptionPane.showMessageDialog(this, ex.getMessage());
                    ex.printStackTrace();
                }

            } else {
                javax.swing.JOptionPane.showMessageDialog(this, "You MUST select a paybill in order to proceed");
            }
            System.out.println("Working on : [" + registerURL + "]");

            callBackURL = callbackURLTxt.getText();

            validationURL = validationURLTxt.getText();

            com.afrisoftech.funsoft.mobilepay.MobilePayAPI.registerCallbackURL(com.afrisoftech.funsoft.mobilepay.Base64Encoding.encodetoBase64String("Si1Y0dik7IoBEFC9buVTGBBdM0A9mQLw:DlPLOhUtuwdAjzDB"), registerURL, callBackURL, validationURL);

            try {
                java.sql.PreparedStatement pstmtCallBack = connectDB.prepareStatement("INSERT INTO public.call_back_url_logs( call_back_url, validation_url) VALUES (?, ?)");
                pstmtCallBack.setString(1, callBackURL);
                pstmtCallBack.setString(2, validationURL);
                pstmtCallBack.execute();
            } catch (SQLException ex) {
                Logger.getLogger(CallBackURSIntfr.class.getName()).log(Level.SEVERE, null, ex);
            }
            
            javax.swing.JOptionPane.showMessageDialog(this, "Call back URLs registered successfully");

        }
        // TODO add your handling code here:
    }//GEN-LAST:event_registerURLBtnActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JLabel callbackURLLbl;
    private javax.swing.JTextField callbackURLTxt;
    private javax.swing.JButton closeFormBtn;
    private javax.swing.JComboBox<String> paybillNoCmbx;
    private javax.swing.JLabel paybillNoLbl;
    private javax.swing.JButton registerURLBtn;
    private javax.swing.JLabel spacerLbl;
    private javax.swing.JPanel urlActionPanel;
    private javax.swing.JPanel urlBodyPanel;
    private javax.swing.JLabel validationURLLbl;
    private javax.swing.JTextField validationURLTxt;
    // End of variables declaration//GEN-END:variables
}
